<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
      />
    <meta
      name="description"
      content="Use Viewer to start building new applications or easily embed Cesium into existing applications."
      />
    <meta name="cesium-sandcastle-labels" content="Beginner, Showcases" />
    <title>Cesium Demo</title>

    <!-- <base href="https://stiwoll.mah.priv.at/sandbox/cesium/Apps/Sandcastle/gallery/"> -->
    <base href="../Apps/Sandcastle/gallery/">

    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script
      type="text/javascript"
      src="../../../Build/CesiumUnminified/Cesium.js"
      nomodule
      ></script>
    <script type="module" src="../load-cesium-es6.js"></script>

    <script src="../../..//node_modules/canvas-gauges/gauge.min.js"></script>
    <link rel="stylesheet" href="../../../standalone/mahViewer/CesiumViewer.css" media="screen" />

  </head>

  <body
    class="sandcastle-loading"
    data-sandcastle-bucket="bucket-requirejs.html"
    >

    <style>
      @import url(../templates/bucket.css);
      #toolbar {
          background: rgba(42, 42, 42, 0.9);
          padding: 4px;
          border-radius: 4px;
      }
      #toolbar input {
          vertical-align: middle;
          padding-top: 2px;
          padding-bottom: 2px;
      }
    </style>

    <div id="cesiumContainer" class="fullSize"></div>

    <div id="toolbar" >
      <h2>Flight</h2>
      <table>
        <tbody>
          <tr>
            <td>
              <canvas id="compass"></canvas>
            </td>
          </tr>
          <tr>
            <td>
              <canvas id="altitude"></canvas>
            </td>
          </tr>
          <tr>
            <td>
              <canvas id="speed"></canvas>
            </td>
          </tr>
          <tr>
            <td>
              <canvas id="temperature"></canvas>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id="loadingIndicator" class="loadingIndicator"></div>

    <script id="cesium_sandcastle_script"  type="module">

      function startup(Cesium) {
          "use strict";
          //Sandcastle_Begin
          /*
            Options parsed from query string:
            source=url          The URL of a CZML/GeoJSON/KML data source to load at startup.
            Automatic data type detection uses file extension.
            sourceType=czml/geojson/kml
            Override data type detection for source.
            flyTo=false         Don't automatically fly to the loaded source.
            tmsImageryUrl=url   Automatically use a TMS imagery provider.
            lookAt=id           The ID of the entity to track at startup.
            stats=true          Enable the FPS performance display.
            inspector=true      Enable the inspector widget.
            debug=true          Full WebGL error reporting at substantial performance cost.
            theme=lighter       Use the dark-text-on-light-background theme.
            scene3DOnly=true    Enable 3D only mode.
            view=longitude,latitude,[height,heading,pitch,roll]
            Automatically set a camera view. Values in degrees and meters.
            [height,heading,pitch,roll] default is looking straight down, [300,0,-90,0]
            saveCamera=false    Don't automatically update the camera view in the URL when it changes.
          */


          var flightOrientation;
          var compass;
          var speed;
          var temperature;
          var altitude;
          var velocityVectorProperty;
          var velocityVector = new  Cesium.Cartesian3();
          var burnerstate = 0;

           Cesium.Ion.defaultAccessToken =
              "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3YmJlMzAyYy1hZTY4LTQ4OTUtYTIxMS02NTBlYzc1MDcxNTAiLCJpZCI6MTQ0MjAsInNjb3BlcyI6WyJhc3IiLCJnYyJdLCJpYXQiOjE1NjU0NzE5Mzl9.j9eQVA5txZG-lRmcUBEwgzRuAWzd0fPxgf5LmM_xNLU";

          var endUserOptions =  Cesium.queryToObject(window.location.search.substring(1));

          var imageryProvider;
          if ( Cesium.defined(endUserOptions.tmsImageryUrl)) {
              imageryProvider = new  Cesium.TileMapServiceImageryProvider({
                  url: endUserOptions.tmsImageryUrl,
              });
          }
          var imageryViewModels =  Cesium.createDefaultImageryProviderViewModels();

          imageryViewModels.push(
              new  Cesium.ProviderViewModel({
                  name: "Austria Basemap",
                  iconUrl:
                  "http://www.geoland.at/assets/images/IndexGrid/basemap_hover_en.png",
                  tooltip: "Austrian OGD Basemap.\nhttps://www.basemap.at/index_en.html",
                  creationFunction: function () {
                      return new  Cesium.WebMapTileServiceImageryProvider({
                          url:
                          "https://maps{s}.wien.gv.at/basemap/bmaporthofoto30cm/{Style}/{TileMatrixSet}/{TileMatrix}/{TileRow}/{TileCol}.jpeg",
                          layer: "bmaporthofoto30cm",
                          style: "normal",
                          format: "image/jpeg",
                          tileMatrixSetID: "google3857",
                          subdomains: "1234",
                          maximumLevel: 19,
                          rectangle:  Cesium.Rectangle.fromDegrees(8.782379, 46.35877, 17.5, 49.037872),
                          credit: new Cesium.Credit(
                              '<a href="https://www.basemap.at/" target="_blank">Datenquelle: basemap.at</a>',
                              true
                          ),
                      });
                  },
              })
          );
          // Select one from the existing list to be currently active.
          var selectedImagery = imageryViewModels[imageryViewModels.length - 1];

          var loadingIndicator = document.getElementById("loadingIndicator");
          // burnerled = document.getElementById("burner");

          var viewer;
          try {
              var hasBaseLayerPicker = ! Cesium.defined(imageryProvider);
              viewer = new  Cesium.Viewer("cesiumContainer", {
                  imageryProviderViewModels: imageryViewModels,
                  selectedImageryProviderViewModel: selectedImagery,

                  imageryProvider: imageryProvider,
                  baseLayerPicker: hasBaseLayerPicker,
                  scene3DOnly: endUserOptions.scene3DOnly,
                  // selectionIndicator: false, //Disable selection indicator
                  //     infoBox: false, //Disable InfoBox widget
                  requestRenderMode: true,
                  geocoder: false,
                  homeButton: false,
                  vrButton: true,
              });
              // viewer.imageryLayers.addImageryProvider(austriaMap);

              if (hasBaseLayerPicker) {
                  var viewModel = viewer.baseLayerPicker.viewModel;
                  viewModel.selectedTerrain = viewModel.terrainProviderViewModels[1];
              } else {
                  viewer.terrainProvider =  Cesium.createWorldTerrain({
                      requestWaterMask: true,
                      requestVertexNormals: true,
                  });
              }
          } catch (exception) {
              loadingIndicator.style.display = "none";
              var message =  Cesium.formatError(exception);
              console.error(message);
              if (!document.querySelector(".cesium-widget-errorPanel")) {
                  //eslint-disable-next-line no-alert
                  window.alert(message);
              }
              return;
          }

          viewer.extend( Cesium.viewerDragDropMixin);
          if (endUserOptions.inspector) {
              viewer.extend( Cesium.viewerCesiumInspectorMixin);
          }

          var showLoadError = function (name, error) {
              var title = "An error occurred while loading the file: " + name;
              var message =
                  "An error occurred while loading the file, which may indicate that it is invalid.  A detailed error report is below:";
              viewer.cesiumWidget.showErrorPanel(title, message, error);
          };

          viewer.dropError.addEventListener(function (viewerArg, name, error) {
              showLoadError(name, error);
          });

          var scene = viewer.scene;
          var context = scene.context;
          if (endUserOptions.debug) {
              context.validateShaderProgram = true;
              context.validateFramebuffer = true;
              context.logShaderCompilation = true;
              context.throwOnWebGLError = true;
          }

          var view = endUserOptions.view;
          var source = endUserOptions.source;
          if ( Cesium.defined(source)) {
              var sourceType = endUserOptions.sourceType;
              if (! Cesium.defined(sourceType)) {
                  // autodetect using file extension if not specified
                  if (/\.czml$/i.test(source)) {
                      sourceType = "czml";
                  } else if (
                      /\.geojson$/i.test(source) ||
                          /\.json$/i.test(source) ||
                          /\.topojson$/i.test(source)
                  ) {
                      sourceType = "geojson";
                  } else if (/\.kml$/i.test(source) || /\.kmz$/i.test(source)) {
                      sourceType = "kml";
                  }
              }

              var loadPromise;
              if (sourceType === "czml") {
                  loadPromise =  Cesium.CzmlDataSource.load(source);
              } else if (sourceType === "geojson") {
                  loadPromise =  Cesium.GeoJsonDataSource.load(source);
              } else if (sourceType === "kml") {
                  loadPromise =  Cesium.KmlDataSource.load(source, {
                      camera: scene.camera,
                      canvas: scene.canvas,
                  });
              } else {
                  showLoadError(source, "Unknown format.");
              }

              if ( Cesium.defined(loadPromise)) {
                  viewer.dataSources
                      .add(loadPromise)
                      .then(function (dataSource) {
                          var lookAt = endUserOptions.lookAt;
                          if ( Cesium.defined(lookAt)) {
                              var entity = dataSource.entities.getById(lookAt);
                              if ( Cesium.defined(entity)) {
                                  viewer.trackedEntity = entity;
                              } else {
                                  var error =
                                      'No entity with id "' +
                                      lookAt +
                                      '" exists in the provided data source.';
                                  showLoadError(source, error);
                              }
                          } else if (! Cesium.defined(view) && endUserOptions.flyTo !== "false") {
                              viewer.flyTo(dataSource);
                          }
                      })
                      .otherwise(function (error) {
                          showLoadError(source, error);
                      });
              }
          }

          if (endUserOptions.stats) {
              scene.debugShowFramesPerSecond = true;
          }

          var theme = endUserOptions.theme;
          if ( Cesium.defined(theme)) {
              if (endUserOptions.theme === "lighter") {
                  document.body.classList.add("cesium-lighter");
                  viewer.animation.applyThemeChanges();
              } else {
                  var error = "Unknown theme: " + theme;
                  viewer.cesiumWidget.showErrorPanel(error, "");
              }
          }

          if ( Cesium.defined(view)) {
              var splitQuery = view.split(/[ ,]+/);
              if (splitQuery.length > 1) {
                  var longitude = !isNaN(+splitQuery[0]) ? +splitQuery[0] : 0.0;
                  var latitude = !isNaN(+splitQuery[1]) ? +splitQuery[1] : 0.0;
                  var height =
                      splitQuery.length > 2 && !isNaN(+splitQuery[2])
                      ? +splitQuery[2]
                      : 300.0;
                  var heading =
                      splitQuery.length > 3 && !isNaN(+splitQuery[3])
                      ? Cesium.Math.toRadians(+splitQuery[3])
                      : undefined;
                  var pitch =
                      splitQuery.length > 4 && !isNaN(+splitQuery[4])
                      ? Cesium.Math.toRadians(+splitQuery[4])
                      : undefined;
                  var roll =
                      splitQuery.length > 5 && !isNaN(+splitQuery[5])
                      ? Cesium.Math.toRadians(+splitQuery[5])
                      : undefined;

                  viewer.camera.setView({
                      destination:  Cesium.Cartesian3.fromDegrees(longitude, latitude, height),
                      orientation: {
                          heading: heading,
                          pitch: pitch,
                          roll: roll,
                      },
                  });
              }
          }

          var camera = viewer.camera;
          function saveCamera() {
              var position = camera.positionCartographic;
              var hpr = "";
              if ( Cesium.defined(camera.heading)) {
                  hpr =
                      "," +
                      Cesium.Math.toDegrees(camera.heading) +
                      "," +
                      Cesium.Math.toDegrees(camera.pitch) +
                      "," +
                      Cesium.Math.toDegrees(camera.roll);
              }
              endUserOptions.view =
                  Cesium.Math.toDegrees(position.longitude) +
                  "," +
                  Cesium.Math.toDegrees(position.latitude) +
                  "," +
                  position.height +
                  hpr;
              history.replaceState(undefined, "", "?" + Cesium.objectToQuery(endUserOptions));
          }

          var timeout;
          if (endUserOptions.saveCamera !== "false") {
              camera.changed.addEventListener(function () {
                  window.clearTimeout(timeout);
                  timeout = window.setTimeout(saveCamera, 1000);
              });
          }

          compass = new RadialGauge({
              renderTo: "compass",
              width: 200,
              height: 200,
              minValue: 0,
              maxValue: 360,
              majorTicks: ["N", "NE", "E", "SE", "S", "SW", "W", "NW", "N"],
              minorTicks: 2,
              ticksAngle: 360,
              startAngle: 180,
              strokeTicks: false,
              highlights: false,
              colorPlate: "#21216F" /* blue plate color : #33a*/,
              colorMajorTicks: "#f5f5f5",
              colorMinorTicks: "#ddd",
              colorNumbers: "#ccc" /* grey = #ccc */,
              colorNeedle: "rgba(240, 128, 128, 1)",
              colorNeedleEnd: "rgba(255, 160, 122, .9)",
              valueBox: false,
              valueTextShadow: false,
              colorNeedleCircleInner: "#fff" /* #fff = white */,
              colorNeedleCircleOuter: "#ccc",
              needleCircleSize: 15,
              needleCircleOuter: false,
              animationRule: "linear",
              needleType: "line" /* arrow or line */,
              needleStart: 40 /*70 - needle tail length*/,
              needleEnd: 60 /*99 - needle head length */,
              needleWidth: 3,
              borders: true,
              borderInnerWidth: 0,
              borderMiddleWidth: 0,
              borderOuterWidth: 10,
              colorBorderOuter: "#ccc",
              colorBorderOuterEnd: "#ccc",
              colorNeedleShadowDown: "#222",
              borderShadowWidth: 0,
              animationTarget: "plate" /* needle or plate*/,
              units: "ᵍ",
              title: "Heading",
              fontTitleSize: 19,
              colorTitle: "#f5f5f5",
              animationDuration: 1500,
              value: 360,
              animateOnInit: true,
          }).draw();

          altitude = new LinearGauge({
              renderTo: "altitude",
              width: 200,
              height: 60,
              minValue: 0,
              maxValue: 2000,
              majorTicks: ["0", "500", "1000", "1500", "2000"],
              minorTicks: 5,
              strokeTicks: true,
              colorPlate: "#fff",
              borderShadowWidth: 0,
              borders: false,
              barBeginCircle: false,
              tickSide: "left",
              numberSide: "left",
              needleSide: "left",
              needleType: "line",
              needleWidth: 3,
              colorNeedle: "#222",
              colorNeedleEnd: "#222",
              animationDuration: 1500,
              animationRule: "linear",
              animationTarget: "plate",
              barWidth: 5,
              title: "Altitude m",
              ticksWidth: 50,
              ticksWidthMinor: 15,
          }).draw();

          speed = new LinearGauge({
              renderTo: "speed",
              width: 200,
              height: 60,
              minValue: 0,
              maxValue: 100,
              majorTicks: [
                  "0",
                  "20",
                  "40",
                  "60",
                  "80",
                  "100",
                  // "120",
                  // "140",
                  // "160"
              ],
              minorTicks: 5,
              strokeTicks: true,
              colorPlate: "#fff",
              borderShadowWidth: 0,
              borders: false,
              barBeginCircle: false,
              tickSide: "left",
              numberSide: "left",
              needleSide: "left",
              needleType: "line",
              needleWidth: 3,
              colorNeedle: "#222",
              colorNeedleEnd: "#222",
              animationDuration: 1500,
              animationRule: "linear",
              animationTarget: "plate",
              barWidth: 5,
              title: "Speed",
              ticksWidth: 50,
              ticksWidthMinor: 15,
          }).draw();

          temperature = new LinearGauge({
              renderTo: "temperature",
              width: 200,
              height: 60,
              minValue: 40,
              maxValue: 140,
              majorTicks: ["40", "60", "80", "100", "120", "140"],
              highlights: [
                  {
                      from: 80,
                      to: 140,
                      color: "rgba(200, 50, 50, .75)",
                  },
              ],
              minorTicks: 5,
              strokeTicks: true,
              colorPlate: "#fff",
              borderShadowWidth: 0,
              borders: false,
              barBeginCircle: false,
              tickSide: "left",
              numberSide: "left",
              needleSide: "left",
              needleType: "line",
              needleWidth: 3,
              colorNeedle: "#222",
              colorNeedleEnd: "#222",
              animationDuration: 1500,
              animationRule: "linear",
              animationTarget: "plate",
              barWidth: 5,
              title: "Temperature °",
              ticksWidth: 50,
              ticksWidthMinor: 15,
          }).draw();

          loadingIndicator.style.display = "none";

          viewer.dataSources.dataSourceAdded.addEventListener(function (
              collection,
              dataSource
          ) {
              var entities = dataSource.entities.values;
              for (var i = 0; i < entities.length; i++) {
                  var entity = entities[i];
                  console.log(entity);
              }
          });

          var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
          handler.setInputAction(function (movement) {
              if (viewer.selectedEntity) {
                  flightOrientation = new  Cesium.VelocityOrientationProperty(
                      viewer.selectedEntity.position
                  );
                  velocityVectorProperty = new  Cesium.VelocityVectorProperty(
                      viewer.selectedEntity.position,
                      false
                  );
                  console.log("select:", viewer.selectedEntity.id, viewer.selectedEntity);

              }
          },  Cesium.ScreenSpaceEventType.LEFT_CLICK);

          viewer.clock.onTick.addEventListener(function (clock) {
              if (viewer.selectedEntity) {
                  const position = viewer.selectedEntity.position.getValue(
                      clock.currentTime
                  );
                  const carto =  Cesium.Cartographic.fromCartesian(position);
                  altitude.value = carto.height;

                  // const lat = Math.toDegrees(carto.latitude);
                  // const lon = Math.toDegrees(carto.longitude);

                  const orientation = flightOrientation.getValue(clock.currentTime);
                  if (orientation) {
                      const heading =  Cesium.Math.toDegrees(Cesium.Quaternion.computeAngle(orientation));
                      compass.value = (heading + 180) % 360;
                  }
                  velocityVectorProperty.getValue(clock.currentTime, velocityVector);
                  if (velocityVector) {
                      var kmPerHour =  Cesium.Cartesian3.magnitude(velocityVector) * 3.6;
                      speed.value = kmPerHour;
                  }

                  var  bs = viewer.selectedEntity.properties.burner_intervals.getValue(
                      clock.currentTime
                  );
                  if (bs != burnerstate) {
                      console.log("burner change to: ", bs);
                      burnerstate = bs;
                  }

                  temperature.value = viewer.selectedEntity.properties.temperature.getValue(
                      clock.currentTime
                  );

                  var basket_heading = viewer.selectedEntity.properties.basket_orientation.getValue(
                      clock.currentTime
                  );
                  if (basket_heading) {
                      // https://github.com/CesiumGS/cesium/pull/6738#issuecomment-401419826
                      var pitch = 0;
                      var roll = 0;
                      var hpr = new  Cesium.HeadingPitchRoll(Cesium.Math.toRadians(basket_heading), pitch, roll);
                      var basket_orientation =  Cesium.Transforms.headingPitchRollQuaternion(position, hpr);
                      viewer.selectedEntity.orientation = basket_orientation;
                  }
              }
          });

          if (endUserOptions.builtin) {
              viewer.dataSources.add(CzmlDataSource.load(czml)).then(function (ds) {
                  // var entity = ds.entities.getById('path');
                  // // viewer.trackedEntity = entity;
                  // var flightOrientation =  new VelocityOrientationProperty(entity.position);
                  // entity.position.setInterpolationOptions({
                  //     interpolationDegree : 1,
                  //     interpolationAlgorithm : Cesium.HermitePolynomialApproximation
                  // });
              });
          }

          //Sandcastle_End
          Sandcastle.finishedLoading();
      }
      if (typeof Cesium !== "undefined") {
          window.startupCalled = true;
          startup(Cesium);
      }
      </script>
  </body>
</html>
